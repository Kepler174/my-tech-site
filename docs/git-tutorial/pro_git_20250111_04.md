---
slug: git-04-04-self-hosting
title: "4.4 Self-Hosting — 搭建私有 Git 服务器"
authors: [yeezi]
tags: [git, progit, 搭建教程, 运维]
date: 2025-01-11T12:00:00
---

好了，理论都讲完了：协议、裸仓库、SSH。
现在我们挽起袖子，在你的 Ubuntu (或任何 Linux) 服务器上，实操搭建一个最基础的 Git 服务。

这是一个“最小可行性产品 (MVP)”级别的搭建过程。

<!--truncate-->

### 第一步：创建 Git 用户

为了安全，我们不应该使用 `root` 来运行服务。创建一个专用的账户。

```bash
$ sudo adduser git
```
然后切换到这个用户：
```bash
$ su git
$ cd /home/git
```

### 第二步：配置 SSH 访问

创建 `.ssh` 目录和 `authorized_keys` 文件。

```bash
$ mkdir .ssh && chmod 700 .ssh
$ touch .ssh/authorized_keys && chmod 600 .ssh/authorized_keys
```

把你自己（开发机）的公钥 (`cat ~/.ssh/id_ed25519.pub`) 复制进去。
此时，你可以尝试在本地电脑用 SSH 连一下：`ssh git@your-server-ip`。如果不用密码就进去了，说明配置成功。

### 第三步：创建仓库

我们在这个用户的目录下创建一个存放代码的文件夹，比如 `repositories`。

```bash
$ mkdir repositories
$ cd repositories
$ git init --bare my-project.git
```
你会看到没有任何报错，只是提示 `Initialized empty Git repository`。

### 第四步：推送代码

回到你的**本地开发电脑**。
假设你已经有一个写了很久的项目了。

```bash
$ cd my-project
$ git remote add origin git@your-server-ip:/home/git/repositories/my-project.git
$ git push -u origin master
```

**成功！**
你刚刚完成了从 0 到 1 的私有 Git 服务器搭建。不需要 GitHub，不需要付费，代码完全在你的掌控之中。

### 禁用 Shell 登录

这里有一个安全隐患：那个 `git` 用户现在的权限有点大，他不仅能推代码，还能 SSH 进去获得一个 Shell，随便敲命令。
为了安全，我们要限制 `git` 用户**只能**做 Git 相关的事。

Git 套件自带了一个 `git-shell` 工具。我们需要把 `git` 用户的登录 shell 换成它。

1.  确认 `git-shell` 的路径：`which git-shell` (通常在 `/usr/bin/git-shell`)。
2.  编辑 `/etc/passwd` 文件。
    找到：`git:x:1000:1000::/home/git:/bin/bash`
    改为：`git:x:1000:1000::/home/git:/usr/bin/git-shell`

现在，如果有人尝试 `ssh git@your-server`，服务器会拒绝登录并告诉他：
`fatal: Interactive git shell is not enabled.`
但是 `git push` 和 `git clone` 依然能正常工作。这就是我们要的效果。
