---
slug: git-02-04-undoing
title: "2.4 Undoing Things — 世上真的有后悔药"
authors: [yeezi]
tags: [git, progit, 撤销]
date: 2025-01-09T10:00:00
---

在任何技术领域，“如果当时能重来”通常只是一个美好的愿望。但在 Git 的世界里，这几乎是日常操作。

作为一个写了十几年代码的人，我必须坦诚：我依然每天都在犯错。
提交了才发现少加了一个文件；
写在这个分支的代码其实应该在那个分支；
或者干脆就是写了一堆垃圾，想把它们全部扔进碎纸机。

好消息是，Git 对“后悔”这件事表现得异常宽容。它提供了多种机制让你修正错误。今天我们就来聊聊这些“后悔药”。

<!--truncate-->

### 修正最后一次提交

这可能是最常用的“后悔药”。
想象一下，你刚刚敲完 `git commit -m "Finish feature X"`，回车一按，突然意识到：
*   哎呀，刚才新建的 `Config.js` 忘记 `git add` 了。
*   或者，那个提交信息里有个极其尴尬的错别字。

此时，千万别急着撤销提交或者再发一个新的修正提交（那样会让 commit 历史变得很脏）。Git 提供了一个优雅的解决方案：`--amend`。

```bash
$ git commit --amend
```

如果你只是想改个提交信息，这条命令会启动你的编辑器，让你修改上一条信息。

如果你是漏了文件，可以这样做：

```bash
$ git add Config.js
$ git commit --amend
```

**发生了什么？**
Git 并没有真正地“修改”旧的提交，而是创建了一个全新的提交，把旧的那个替换掉了。这就像你把写坏的草稿纸揉成团扔掉，换了一张新的重新写一样。从结果来看，旧的提交从未存在过。

### 取消暂存的文件 (Unstaging)

我们在第2.2章提到过，`git add` 会把文件放入“暂存区”。
有时候你手一抖，执行了 `git add .`，结果把 `DEBUG.log` 这种本不该提交的文件也加进去了。

怎么把它们从暂存区“拿”出来，放回工作区呢？

`git status` 其实是个很贴心的助手，它通常会提示你该怎么做。但在新旧版本的 Git 中，命令略有不同。

**传统方式 (Reset):**

```bash
$ git reset HEAD <file>
```

这个命令读起来有点拗口，“重置头指针”？其实你只需要记住，它的作用就是把文件移出暂存区，但不改动文件内容。

**现代方式 (Restore):**
从 Git 2.23 版本开始，Git 引入了语义更清晰的命令：

```bash
$ git restore --staged <file>
```

如果你用的是比较新的 Git 版本，我强烈建议使用 `verify`，因为它不仅语义清晰，而且不容易误操作。

### 撤销对文件的修改

这是一个危险的操作。请确保你真的读懂了这一节。

场景是这样的：你修改了 `CONTRIBUTING.md` 文件，写了一大段之后发现思路完全错了，甚至不如没改之前。你不想从编辑器里一直按 `Ctrl+Z`，你想直接让这个文件回到“上次提交时的样子”。

**传统方式:**
```bash
$ git checkout -- <file>
```

**现代方式:**
```bash
$ git restore <file>
```

**为什么说它危险？**
因为你刚刚写的代码（虽然你觉得是垃圾）会瞬间消失。Git 没有对这些**未提交**的内容做备份。一旦还原，神仙也找不回来。

所以，除非你百分之百确定这些修改毫无价值，否则我建议你养成一个好习惯：**不要直接还原，而是把它们暂存起来或者提交到一个临时分支**，确认真的不需要了再删。

### 总结

Git 的撤销功能非常强大，但也伴随着风险：
1.  `git commit --amend`：修正上一次提交（这是安全的，只要你还没推送到远程服务器）。
2.  `git restore --staged`：把文件从暂存区拿出来（安全的，不会丢代码）。
3.  `git restore`：把文件恢复到未修改状态（**危险**，会丢代码）。

记住，Git 中几乎所有提交过的东西都能找回来，但那些还没提交就被你 `restore` 掉的东西，就真的随风而去了。
